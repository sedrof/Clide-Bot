name: Deploy Pump.fun Bot to VPS

on:
  push:
    branches:
      - main
      - deploy-pump-bot
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

      
    - name: Setup SSH Key
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key
        chmod 600 private_key

    - name: Debug Deployment Info
      env:
        HOST: ${{ secrets.HOST }}
        USERNAME: ${{ secrets.USERNAME }}
      run: |
        echo "Deploying Pump.fun Bot to $HOST as $USERNAME"
        echo "Target directory: /home/azureuser/pump-bot/"
        if [ -z "$HOST" ]; then
          echo "Error: HOST is not set."
          exit 1
        fi
        if [ -z "$USERNAME" ]; then
          echo "Error: USERNAME is not set."
          exit 1
        fi

    - name: Create deployment directory structure
      env:
        USERNAME: ${{ secrets.USERNAME }}
        HOST: ${{ secrets.HOST }}
      run: |
        ssh -i private_key -o StrictHostKeyChecking=no $USERNAME@$HOST "
          echo 'Creating pump-bot directory structure...'
          mkdir -p /home/azureuser/pump-bot/{config,logs,venv,deployment}
          echo 'Directory structure created successfully'
        "

    - name: Deploy Pump.fun Bot files
      env:
        USERNAME: ${{ secrets.USERNAME }}
        HOST: ${{ secrets.HOST }}
      run: |
        echo "Syncing pump-bot files..."
        rsync -avz --progress \
          --exclude='venv/' \
          --exclude='__pycache__/' \
          --exclude='.git/' \
          --exclude='*.pyc' \
          --exclude='.env' \
          --exclude='logs/*.log' \
          --exclude='node_modules/' \
          -e "ssh -i private_key -o StrictHostKeyChecking=no" \
          . $USERNAME@$HOST:/home/azureuser/pump-bot/

    - name: Install Python dependencies and setup environment
      env:
        USERNAME: ${{ secrets.USERNAME }}
        HOST: ${{ secrets.HOST }}
      run: |
        ssh -i private_key -o StrictHostKeyChecking=no $USERNAME@$HOST "
          cd /home/azureuser/pump-bot
          
          echo 'Setting up Python virtual environment...'
          # Remove broken venv if activate script is missing
          if [ -d venv ] && [ ! -f venv/bin/activate ]; then
            echo 'Removing broken virtual environment...'
            rm -rf venv
          fi
          
          if [ ! -d venv ]; then
            python3 -m venv venv
          fi
          
          source venv/bin/activate
          
          echo 'Installing dependencies...'
          pip install --upgrade pip wheel setuptools
          
          # Install main requirements
          pip install -r requirements.txt
          
          # Install additional dependencies for telegram bot and monitoring
          pip install python-telegram-bot psutil requests aiofiles aiohttp-cors
          
          # Verify critical imports
          python -c 'import telegram; print(\"‚úì telegram module OK\")'
          python -c 'import psutil; print(\"‚úì psutil module OK\")'
          python -c 'import aiofiles; print(\"‚úì aiofiles module OK\")'
          
          echo 'Setting up directories...'
          mkdir -p logs
          chmod 755 logs
          
          echo 'Dependencies installed successfully'
        "

    - name: Setup systemd services for pump-bot
      env:
        USERNAME: ${{ secrets.USERNAME }}
        HOST: ${{ secrets.HOST }}
      run: |
        ssh -i private_key -o StrictHostKeyChecking=no $USERNAME@$HOST "
          cd /home/azureuser/pump-bot
          
          echo 'Setting up systemd services...'
          
          # Check if deployment files exist
          if [ ! -f deployment/pump-bot.service ]; then
            echo 'ERROR: Service files not found in deployment folder!'
            ls -la deployment/ || echo 'Deployment folder missing'
            exit 1
          fi
          
          # Copy service files
          sudo cp deployment/pump-bot.service /etc/systemd/system/
          sudo cp deployment/pump-bot-telegram.service /etc/systemd/system/
          sudo cp deployment/pump-bot-web.service /etc/systemd/system/
          
          # Set correct permissions
          sudo chmod 644 /etc/systemd/system/pump-bot*.service
          
          # Reload systemd
          sudo systemctl daemon-reload
          
          # Enable services (but don't start them yet)
          sudo systemctl enable pump-bot-telegram
          sudo systemctl enable pump-bot-web
          
          echo 'Systemd services configured successfully'
        "

    - name: Create environment file locally
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_AUTHORIZED_USERS: ${{ secrets.TELEGRAM_AUTHORIZED_USERS }}
        DRPC_API_KEY: ${{ secrets.DRPC_API_KEY }}
      run: |
        echo "Creating environment configuration file..."
        echo "TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}" > .env
        echo "TELEGRAM_AUTHORIZED_USERS=${TELEGRAM_AUTHORIZED_USERS}" >> .env
        echo "DRPC_API_KEY=${DRPC_API_KEY}" >> .env
        echo "WEB_MONITOR_PORT=8889" >> .env
        chmod 600 .env

    - name: Deploy environment file and finalize setup
      env:
        USERNAME: ${{ secrets.USERNAME }}
        HOST: ${{ secrets.HOST }}
      run: |
        echo "Copying environment file to VPS..."
        scp -i private_key -o StrictHostKeyChecking=no .env $USERNAME@$HOST:/home/azureuser/pump-bot/.env
        
        ssh -i private_key -o StrictHostKeyChecking=no $USERNAME@$HOST "
          cd /home/azureuser/pump-bot
          
          echo 'Setting secure permissions on environment file...'
          chmod 600 .env
          chown azureuser:azureuser .env
          
          echo 'Environment configuration completed successfully'
        "

    - name: Restart and verify pump-bot services
      env:
        USERNAME: ${{ secrets.USERNAME }}
        HOST: ${{ secrets.HOST }}
      run: |
        ssh -i private_key -o StrictHostKeyChecking=no $USERNAME@$HOST "
          echo 'üîÑ Restarting pump-bot services...'
          
          # Stop trading bot if running (controlled via telegram)
          sudo systemctl stop pump-bot || true
          
          # Restart always-on services
          sudo systemctl restart pump-bot-telegram
          sudo systemctl restart pump-bot-web
          
          # Wait for services to stabilize
          sleep 10
          
          # Verify services are running
          echo ''
          echo 'üìä Service Health Check:'
          echo '========================'
          
          # Check Telegram controller
          if sudo systemctl is-active --quiet pump-bot-telegram; then
            echo '‚úÖ Telegram Controller: Running'
            sudo journalctl -u pump-bot-telegram -n 5 --no-pager | grep -E '(Started|ERROR)' || true
          else
            echo '‚ùå Telegram Controller: Failed'
            sudo journalctl -u pump-bot-telegram -n 10 --no-pager
            exit 1
          fi
          
          # Check Web Monitor
          if sudo systemctl is-active --quiet pump-bot-web; then
            echo '‚úÖ Web Monitor: Running on port 8889'
            # Test if web server responds
            if curl -s -o /dev/null -w '%{http_code}' http://localhost:8889 | grep -q '200'; then
              echo '‚úÖ Web Monitor: Responding to requests'
            else
              echo '‚ö†Ô∏è  Web Monitor: Running but not responding'
            fi
          else
            echo '‚ùå Web Monitor: Failed'
            sudo journalctl -u pump-bot-web -n 10 --no-pager
            exit 1
          fi
          
          echo ''
          echo 'üéâ Deployment completed successfully!'
          echo 'üì± Telegram bot is ready for commands'
          echo 'üåê Web monitor available at: http://$(curl -s ifconfig.me):8889'
        "

        
    - name: Deployment Summary
      run: |
        echo "üöÄ Pump.fun Bot Deployment Summary:"
        echo "‚úÖ Code deployed to /home/azureuser/pump-bot/"
        echo "‚úÖ Python dependencies installed"
        echo "‚úÖ Systemd services configured"
        echo "‚úÖ Environment variables set"
        echo "‚úÖ Telegram controller started"
        echo "‚úÖ Web monitor started on port 8889"
        echo ""
        echo "üì± Telegram Bot Commands:"
        echo "/start - Open bot control panel"
        echo ""
        echo "üåê Web Monitor:"
        echo "http://YOUR_VPS_IP:8889"
        echo ""
        echo "‚öôÔ∏è Available Services:"
        echo "- pump-bot-telegram (Telegram controller)"
        echo "- pump-bot-web (Web monitor)"
        echo "- pump-bot (Trading bot - controlled via Telegram)"

    - name: Cleanup
      if: always()
      run: |
        rm -f private_key .env